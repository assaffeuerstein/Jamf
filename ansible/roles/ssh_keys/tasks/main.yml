---
# SSH Keys Role - Manages authorized SSH keys
#
# This role ensures SSH keys are properly configured for the specified user.
#
# Variables:
#   ssh_user: Target user (default: buildadmin)
#   ssh_user_group: User's primary group (default: admin)
#   role_ssh_keys: List of SSH public keys to authorize

- name: Ensure .ssh directory exists
  ansible.builtin.file:
    path: "/Users/{{ ssh_user | default('buildadmin') }}/.ssh"
    state: directory
    owner: "{{ ssh_user | default('buildadmin') }}"
    group: "{{ ssh_user_group | default('admin') }}"
    mode: '0700'

- name: Configure authorized_keys
  ansible.builtin.authorized_key:
    user: "{{ ssh_user | default('buildadmin') }}"
    key: "{{ item }}"
    state: present
  loop: "{{ role_ssh_keys | default([]) }}"
  when: role_ssh_keys is defined and role_ssh_keys | length > 0

- name: Set correct permissions on authorized_keys
  ansible.builtin.file:
    path: "/Users/{{ ssh_user | default('buildadmin') }}/.ssh/authorized_keys"
    owner: "{{ ssh_user | default('buildadmin') }}"
    group: "{{ ssh_user_group | default('admin') }}"
    mode: '0600'
  when: role_ssh_keys is defined and role_ssh_keys | length > 0

