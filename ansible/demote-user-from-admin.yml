---
# demote-user-from-admin.yml
# Removes a user from the admin group on Mac machines

- name: Demote User from Admin
  hosts: "{{ target_hosts | default('build_macs') }}"
  remote_user: "{{ admin_user | default('automation_user') }}"
  become_user: root
  become: yes
  gather_facts: no

  vars:
    # User to demote (must be specified)
    user_to_demote: "{{ demote_user | default('') }}"

  tasks:
    - name: Validate user_to_demote is specified
      fail:
        msg: "Variable 'user_to_demote' or 'demote_user' must be specified"
      when: user_to_demote | length == 0

    - name: Check if user is currently admin
      command: '/usr/bin/dscl . -read "/groups/admin" GroupMembership'
      register: admin_members
      changed_when: false

    - name: Display current admin members
      debug:
        msg: "Current admin members: {{ admin_members.stdout }}"

    - name: Demote user from admin group
      command: '/usr/sbin/dseditgroup -o edit -d {{ user_to_demote }} admin'
      when: user_to_demote in admin_members.stdout
      register: demote_result
      ignore_errors: yes

    - name: Verify demotion
      command: '/usr/bin/dscl . -read "/groups/admin" GroupMembership'
      register: new_admin_members
      changed_when: false

    - name: Display result
      debug:
        msg: "{{ 'User ' + user_to_demote + ' has been removed from admin group' if user_to_demote not in new_admin_members.stdout else 'User is still an admin (demotion may have failed)' }}"

