---
# configure-shell-env.yml
# Configures shell environment (PATH, etc.) for users

- name: Configure Shell Environment
  hosts: "{{ target_hosts | default('build_macs') }}"
  remote_user: "{{ admin_user | default('automation_user') }}"
  gather_facts: yes

  vars:
    # User to configure environment for
    target_user: "{{ env_user | default(admin_user) | default('automation_user') }}"

  tasks:
    - name: Check if .zprofile exists
      stat:
        path: "/Users/{{ target_user }}/.zprofile"
      register: stat_result
      become_user: "{{ target_user }}"

    - name: Create .zprofile if it doesn't exist
      file:
        path: "/Users/{{ target_user }}/.zprofile"
        state: touch
        owner: "{{ target_user }}"
        mode: '0644'
      when: not stat_result.stat.exists
      become_user: "{{ target_user }}"

    - name: Configure PATH for Apple Silicon Macs
      blockinfile:
        dest: "/Users/{{ target_user }}/.zprofile"
        block: |
          # Homebrew PATH (Apple Silicon)
          export PATH="/opt/homebrew/bin:/opt/homebrew/sbin:$PATH"
        marker: "# {mark} ANSIBLE MANAGED BLOCK - HOMEBREW PATH"
      become_user: "{{ target_user }}"
      when: ansible_machine == 'arm64'

    - name: Configure PATH for Intel Macs
      blockinfile:
        dest: "/Users/{{ target_user }}/.zprofile"
        block: |
          # Homebrew PATH (Intel)
          export PATH="/usr/local/bin:/usr/local/sbin:$PATH"
        marker: "# {mark} ANSIBLE MANAGED BLOCK - HOMEBREW PATH"
      become_user: "{{ target_user }}"
      when: ansible_machine == 'x86_64'

    - name: Verify .zprofile contents
      shell: cat /Users/{{ target_user }}/.zprofile
      register: zprofile_contents
      changed_when: false
      become_user: "{{ target_user }}"

    - name: Display .zprofile
      debug:
        msg: "{{ zprofile_contents.stdout_lines }}"

