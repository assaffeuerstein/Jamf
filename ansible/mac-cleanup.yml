---
# mac-cleanup.yml
# Cleans up and resets Mac machines to a baseline state
# Useful for deprovisioning or preparing machines for reallocation

- name: Mac Cleanup
  hosts: "{{ target_hosts | default('cleanup_targets') }}"
  remote_user: "{{ admin_user | default('automation_user') }}"
  gather_facts: yes
  become_user: root
  become: yes

  vars:
    # Users to remove during cleanup (customize as needed)
    users_to_remove:
      - jenkins
      - jenkins_agent
      - build_agent
    # Applications to remove
    apps_to_remove:
      - 'Android Studio.app'
      - 'Visual Studio.app'
      - 'Xcode.app'
      - 'Unity'
      - 'Unity Hub.app'
      - 'Docker.app'
    # Minimum packages to reinstall after cleanup
    minimum_packages:
      - coreutils
      - lldpd
      - telegraf
      - wget
      - jq

  tasks:
    # Optional: Reset hostname to a generic name
    # - name: Set a random 4-digit number as a fact
    #   set_fact:
    #     random_number: "{{ 1000 | random(seed=inventory_hostname) | int + 9000 }}"
    #
    # - name: Set a new hostname as a fact
    #   set_fact:
    #     new_hostname: "free-mac-{{ random_number }}"
    #
    # - name: Set HostName, LocalHostName and ComputerName and flush DNS
    #   command: '{{ item }}'
    #   with_items:
    #     - 'scutil --set HostName {{ new_hostname }}'
    #     - 'scutil --set LocalHostName {{ new_hostname }}'
    #     - 'scutil --set ComputerName {{ new_hostname }}'
    #     - 'killall -HUP mDNSResponder'
    #     - 'killall mDNSResponderHelper'
    #     - 'dscacheutil -flushcache'
    #   ignore_errors: yes

    - name: Run Jamf Recon (update inventory)
      shell: /usr/local/bin/jamf recon
      ignore_errors: yes

    - name: Configure DHCP (release static IP)
      shell: "networksetup -setdhcp Ethernet"
      ignore_errors: yes

    # Optional: Kill running processes
    # - name: Kill Unity processes
    #   shell: ps -ef | grep -i unity | grep -v grep | awk '{print $2}' | xargs kill -9
    #   ignore_errors: yes

    # Optional: Remove users
    # - name: Remove user(s)
    #   shell: /usr/sbin/sysadminctl -deleteUser {{ item }} -secure
    #   with_items: "{{ users_to_remove }}"
    #   ignore_errors: yes

    # Optional: Clean agent work directories
    # - name: Delete all agents workdir's under /opt/*-mac-*
    #   shell: rm -rf /opt/*-mac-*
    #   ignore_errors: yes

    # Optional: Remove applications
    # - name: Delete Applications
    #   file:
    #     path: '/Applications/{{ item }}'
    #     state: absent
    #   with_items: "{{ apps_to_remove }}"
    #   ignore_errors: yes

    # Optional: Clean Homebrew (uncomment if needed)
    # - name: Determine Homebrew prefix
    #   set_fact:
    #     homebrew_prefix: "{{ '/opt/homebrew' if ansible_machine == 'arm64' else '/usr/local' }}"
    #
    # - name: Build Homebrew paths
    #   set_fact:
    #     brew_bin: "{{ homebrew_prefix }}/bin/brew"
    #     cellar_dir: "{{ homebrew_prefix }}/Cellar"
    #
    # - name: Remove all installed homebrew casks
    #   shell: for i in $({{ brew_bin }} list --cask); do {{ brew_bin }} remove --cask --force --ignore-dependencies ${i}; done
    #   become_user: "{{ admin_user }}"
    #   ignore_errors: yes
    #
    # - name: Remove all installed homebrew formulas
    #   shell: for i in $({{ brew_bin }} list); do {{ brew_bin }} remove --force --ignore-dependencies ${i}; done
    #   become_user: "{{ admin_user }}"
    #   ignore_errors: yes
    #
    # - name: Clear all Cellar stuff
    #   shell: rm -rf {{ cellar_dir }}/*
    #
    # - name: Install minimum required homebrew formulas
    #   homebrew:
    #     name: "{{ item }}"
    #     state: latest
    #     upgrade_all: no
    #     update_homebrew: yes
    #   with_items: "{{ minimum_packages }}"
    #   become_user: "{{ admin_user }}"

    # Optional: Run Jamf Policy and Reboot
    # - name: Run Jamf Policy
    #   shell: /usr/local/bin/jamf policy
    #
    # - name: Reboot Mac
    #   command: /sbin/shutdown -r now
    #   ignore_errors: yes

